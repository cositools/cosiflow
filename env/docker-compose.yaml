services:
  postgres:
    image: postgres:15
    container_name: cosi_postgres
    environment:
      - POSTGRES_USER=airflow_user
      - POSTGRES_PASSWORD=secure_password
      - POSTGRES_DB=airflow_db
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "airflow_user"]
      interval: 5s
      timeout: 5s
      retries: 10
    # volumes:
     # - ${HOME}/postgres_data:/var/lib/postgresql/data
    #restart: always

  airflow:
    image: airflow:1.1.0
    build:
      context: .
      dockerfile: Dockerfile.airflow
    container_name: cosi_airflow
    environment:
      - AIRFLOW_HOME=/home/gamma/airflow
      - DISPLAY=${DISPLAY}
      - AIRFLOW__CORE__LOAD_EXAMPLES=False
      - ALERT_SMTP_SERVER=mailhog
      - ALERT_SMTP_PORT=1025
      - ALERT_EMAIL_SENDER=donotreply@cosiflow.alert.errors.it
    # env_file:
    #  - .env
    volumes:
      - ../dags:/home/gamma/airflow/dags
      - ../plugins:/home/gamma/airflow/plugins
      - ../callbacks:/home/gamma/airflow/callbacks
      - ./airflow.cfg.postgresql:/home/gamma/airflow/airflow.cfg
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      - ${HOME}/cosiflow:/shared_dir
      - ${HOME}/cosiflow/data:/home/gamma/workspace/heasarc
    ports:
      - "8080:8080"
      - "28888:28888" #jupyter notebook
    depends_on:
      postgres:
        condition: 
          service_healthy
      
    #restart: always   
    entrypoint: ["bash", "/home/gamma/entrypoint-airflow.sh"]
    #entrypoint: ["tail", "-f", "/dev/null"]

  mailhog:
    image: mailhog/mailhog
    container_name: cosi_mailhog
    ports:
      - "1025:1025"   # SMTP
      - "8025:8025"   # Web UI: http://localhost:8025
volumes:
  postgres_data:
